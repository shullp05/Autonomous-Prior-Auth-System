# Modelfile generated by "ollama FROM hf.co/unsloth/Ministral-3-3B-Instruct-2512-GGUF:Q8_0"
# Build: ollama create pa-audit-ministral8 -f models/pa-audit-ministral8/Modelfile
FROM hf.co/unsloth/Ministral-3-3B-Instruct-2512-GGUF:Q8_0

# 1. OPTIMIZED TEMPLATE
# This template is aligned with Mistral's specific tool-calling syntax (v3/Tekken)
# It ensures tools are injected correctly before the instruction starts.
TEMPLATE """{{- if .Messages }}
{{- range $index, $_ := .Messages }}
{{- if eq .Role "user" }}
{{- if and (le (len (slice $.Messages $index)) 2) $.Tools }}[AVAILABLE_TOOLS]{{ $.Tools }}[/AVAILABLE_TOOLS]
{{- end }}[INST]{{ .Content }}[/INST]
{{- else if eq .Role "assistant" }}
{{- if .Content }}{{ .Content }}</s>
{{- else if .ToolCalls }}[TOOL_CALLS][
{{- range .ToolCalls }}{"name": "{{ .Function.Name }}", "arguments": {{ .Function.Arguments }}}
{{- end }}]</s>
{{- end }}
{{- else if eq .Role "tool" }}[TOOL_RESULTS]{"content": {{ .Content }}}[/TOOL_RESULTS]
{{- end }}
{{- end }}
{{- end }}"""

# 2. REFINED SYSTEM PROMPT
# Removed generic "Tool Instructions" (Ollama handles this automatically with the template).
# Added explicit "JSON Mode" reinforcement for the 3B model.
SYSTEM """You are a Senior Utilization Review Medical Director. Your goal is to evaluate clinical eligibility for medications based on the provided notes and policy criteria.

CRITICAL RULES:
1. RESPONSE FORMAT: You must output ONLY valid JSON. Do not include markdown formatting (like ```json), distinct preambles, or postscripts.
2. FACTS: Use strictly the provided patient history. Do not halllucinate ICD-10 codes or lab values.
3. AMBIGUITY: If criteria are not met or data is missing, the decision is "DENIED" or "PENDING_INFO", never guess.

Your output JSON schema must strictly follow the user's requested structure."""

# 3. TUNED PARAMETERS
# Parser set to mistral to handle specific tokenization for tools
PARSER mistral

# Context Window: Increased for analyzing long clinical notes/history
PARAMETER num_ctx 2048

# Temperature: Lowered for maximum determinism (crucial for JSON)
PARAMETER temperature 0.1

# Repeat Penalty: Lowered. 
# High penalties break JSON (e.g., repeating keys like "diagnosis", "date")
PARAMETER repeat_penalty 1.05

# Predict Limit: Increased slightly to ensure full JSON objects don't cut off
PARAMETER num_predict 1024

# Stop Sequences
PARAMETER stop "</s>"
PARAMETER stop "[INST]"
PARAMETER stop "[/INST]"
PARAMETER stop "[TOOL_RESULTS]"


